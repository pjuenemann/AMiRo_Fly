<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="7,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">classdef</span> MadgwickAHRS &lt; handle</span></span>
<span class="srcline"><span class="lineno"><a href="7,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%MADGWICKAHRS Implementation of Madgwick's IMU and AHRS algorithms</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">%   For more information see:</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%   http://www.x-io.co.uk/node/8#open_source_ahrs_and_imu_algorithms</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">%   Date          Author          Notes</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">%   28/09/2011    SOH Madgwick    Initial release</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,9" id="srcline9"> 9</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,10" id="srcline10">10</a></span><span class="line">    <span class="comment">%% Public properties</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,11" id="srcline11">11</a></span><span class="line">    <span class="keyword">properties</span> (Access = public)</span></span>
<span class="srcline"><span class="lineno"><a href="7,12" id="srcline12">12</a></span><span class="line">        SamplePeriod = 1/256;</span></span>
<span class="srcline"><span class="lineno"><a href="7,13" id="srcline13">13</a></span><span class="line">        Quaternion = [1 0 0 0];     <span class="comment">% output quaternion describing the Earth relative to the sensor</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,14" id="srcline14">14</a></span><span class="line">        Beta = 1;               	<span class="comment">% algorithm gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,15" id="srcline15">15</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,16" id="srcline16">16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,17" id="srcline17">17</a></span><span class="line">    <span class="comment">%% Public methods</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,18" id="srcline18">18</a></span><span class="line">    <span class="keyword">methods</span> (Access = public)</span></span>
</pre>
</div>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="7,19" id="srcline19">19</a></span><span class="line">        <span class="keyword">function</span> <span class="var type1" id="S7T9U34">obj</span> = <span class="mxinfo " id="T9:U2">MadgwickAHRS</span>(<span class="var type1" id="S8T9U37">varargin</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="7,20" id="srcline20">20</a></span><span class="line">            <span class="keyword">for</span> <span class="var type1" id="S9T4U40">i</span> = <span class="mxinfo " id="T4:U5">1</span>:2:nargin</span></span>
<span class="srcline"><span class="lineno"><a href="7,21" id="srcline21">21</a></span><span class="line">                <span class="keyword">if</span>  strcmp(<span class="var type1" id="S8T10U52">varargin</span>{<span class="var type1" id="S9T4U53">i</span>}, <span class="string">'SamplePeriod'</span>), <span class="mxinfo " id="T4:U8"><span class="mxinfo " id="T4:U9"><span class="var type1" id="S7T9U58">obj</span>.SamplePeriod</span> = <span class="mxinfo " id="T4:U11"><span class="var type1" id="S8T10U61">varargin</span>{<span class="var type1" id="S9T4U63">i</span>+1}</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="7,22" id="srcline22">22</a></span><span class="line">                <span class="keyword">elseif</span>  strcmp(<span class="var type1" id="S8T10U69">varargin</span>{<span class="var type1" id="S9T4U70">i</span>}, <span class="string">'Quaternion'</span>), <span class="var type0" id="S7T0U75">obj</span>.Quaternion = <span class="var type0" id="S8T0U78">varargin</span>{<span class="var type0" id="S9T0U80">i</span>+1};</span></span>
<span class="srcline"><span class="lineno"><a href="7,23" id="srcline23">23</a></span><span class="line">                <span class="keyword">elseif</span>  strcmp(<span class="var type1" id="S8T10U86">varargin</span>{<span class="var type1" id="S9T4U87">i</span>}, <span class="string">'Beta'</span>), <span class="mxinfo " id="T4:U18"><span class="mxinfo " id="T4:U19"><span class="var type1" id="S7T9U92">obj</span>.Beta</span> = <span class="mxinfo " id="T4:U21"><span class="var type1" id="S8T10U95">varargin</span>{<span class="var type1" id="S9T4U97">i</span>+1}</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="7,24" id="srcline24">24</a></span><span class="line">                <span class="keyword">else</span> error(<span class="string">'Invalid argument'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="7,25" id="srcline25">25</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,26" id="srcline26">26</a></span><span class="line">            <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="7,27" id="srcline27">27</a></span><span class="line">        <span class="keyword">end</span></span></span>
</pre>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="7,28" id="srcline28">28</a></span><span class="line">        <span class="keyword">function</span> obj = Update(obj, Gyroscope, Accelerometer, Magnetometer)</span></span>
<span class="srcline"><span class="lineno"><a href="7,29" id="srcline29">29</a></span><span class="line">            q = obj.Quaternion; <span class="comment">% short name local variable for readability</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,30" id="srcline30">30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,31" id="srcline31">31</a></span><span class="line">            <span class="comment">% Normalise accelerometer measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,32" id="srcline32">32</a></span><span class="line">            <span class="keyword">if</span>(norm(Accelerometer) == 0), <span class="keyword">return</span>; <span class="keyword">end</span>	<span class="comment">% handle NaN</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,33" id="srcline33">33</a></span><span class="line">            Accelerometer = Accelerometer / norm(Accelerometer);	<span class="comment">% normalise magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,34" id="srcline34">34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,35" id="srcline35">35</a></span><span class="line">            <span class="comment">% Normalise magnetometer measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,36" id="srcline36">36</a></span><span class="line">            <span class="keyword">if</span>(norm(Magnetometer) == 0), <span class="keyword">return</span>; <span class="keyword">end</span>	<span class="comment">% handle NaN</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,37" id="srcline37">37</a></span><span class="line">            Magnetometer = Magnetometer / norm(Magnetometer);	<span class="comment">% normalise magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,38" id="srcline38">38</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,39" id="srcline39">39</a></span><span class="line">            <span class="comment">% Reference direction of Earth's magnetic feild</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,40" id="srcline40">40</a></span><span class="line">            h = quaternProd(q, quaternProd([0 Magnetometer], quaternConj(q)));</span></span>
<span class="srcline"><span class="lineno"><a href="7,41" id="srcline41">41</a></span><span class="line">            b = [0 norm([h(2) h(3)]) 0 h(4)];</span></span>
<span class="srcline"><span class="lineno"><a href="7,42" id="srcline42">42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,43" id="srcline43">43</a></span><span class="line">            <span class="comment">% Gradient decent algorithm corrective step</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,44" id="srcline44">44</a></span><span class="line">            F = [2*(q(2)*q(4) - q(1)*q(3)) - Accelerometer(1)</span></span>
<span class="srcline"><span class="lineno"><a href="7,45" id="srcline45">45</a></span><span class="line">                2*(q(1)*q(2) + q(3)*q(4)) - Accelerometer(2)</span></span>
<span class="srcline"><span class="lineno"><a href="7,46" id="srcline46">46</a></span><span class="line">                2*(0.5 - q(2)^2 - q(3)^2) - Accelerometer(3)</span></span>
<span class="srcline"><span class="lineno"><a href="7,47" id="srcline47">47</a></span><span class="line">                2*b(2)*(0.5 - q(3)^2 - q(4)^2) + 2*b(4)*(q(2)*q(4) - q(1)*q(3)) - Magnetometer(1)</span></span>
<span class="srcline"><span class="lineno"><a href="7,48" id="srcline48">48</a></span><span class="line">                2*b(2)*(q(2)*q(3) - q(1)*q(4)) + 2*b(4)*(q(1)*q(2) + q(3)*q(4)) - Magnetometer(2)</span></span>
<span class="srcline"><span class="lineno"><a href="7,49" id="srcline49">49</a></span><span class="line">                2*b(2)*(q(1)*q(3) + q(2)*q(4)) + 2*b(4)*(0.5 - q(2)^2 - q(3)^2) - Magnetometer(3)];</span></span>
<span class="srcline"><span class="lineno"><a href="7,50" id="srcline50">50</a></span><span class="line">            J = [-2*q(3),                 	2*q(4),                    -2*q(1),                         2*q(2)</span></span>
<span class="srcline"><span class="lineno"><a href="7,51" id="srcline51">51</a></span><span class="line">                2*q(2),                 	2*q(1),                    	2*q(4),                         2*q(3)</span></span>
<span class="srcline"><span class="lineno"><a href="7,52" id="srcline52">52</a></span><span class="line">                0,                         -4*q(2),                    -4*q(3),                         0</span></span>
<span class="srcline"><span class="lineno"><a href="7,53" id="srcline53">53</a></span><span class="line">                -2*b(4)*q(3),               2*b(4)*q(4),               -4*b(2)*q(3)-2*b(4)*q(1),       -4*b(2)*q(4)+2*b(4)*q(2)</span></span>
<span class="srcline"><span class="lineno"><a href="7,54" id="srcline54">54</a></span><span class="line">                -2*b(2)*q(4)+2*b(4)*q(2),	2*b(2)*q(3)+2*b(4)*q(1),	2*b(2)*q(2)+2*b(4)*q(4),       -2*b(2)*q(1)+2*b(4)*q(3)</span></span>
<span class="srcline"><span class="lineno"><a href="7,55" id="srcline55">55</a></span><span class="line">                2*b(2)*q(3),                2*b(2)*q(4)-4*b(4)*q(2),	2*b(2)*q(1)-4*b(4)*q(3),        2*b(2)*q(2)];</span></span>
<span class="srcline"><span class="lineno"><a href="7,56" id="srcline56">56</a></span><span class="line">            step = (J'*F);</span></span>
<span class="srcline"><span class="lineno"><a href="7,57" id="srcline57">57</a></span><span class="line">            step = step / norm(step);	<span class="comment">% normalise step magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,58" id="srcline58">58</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,59" id="srcline59">59</a></span><span class="line">            <span class="comment">% Compute rate of change of quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,60" id="srcline60">60</a></span><span class="line">            qDot = 0.5 * quaternProd(q, [0 Gyroscope(1) Gyroscope(2) Gyroscope(3)]) - obj.Beta * step';</span></span>
<span class="srcline"><span class="lineno"><a href="7,61" id="srcline61">61</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,62" id="srcline62">62</a></span><span class="line">            <span class="comment">% Integrate to yield quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,63" id="srcline63">63</a></span><span class="line">            q = q + qDot * obj.SamplePeriod;</span></span>
<span class="srcline"><span class="lineno"><a href="7,64" id="srcline64">64</a></span><span class="line">            obj.Quaternion = q / norm(q); <span class="comment">% normalise quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,65" id="srcline65">65</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,66" id="srcline66">66</a></span><span class="line">        <span class="keyword">function</span> obj = UpdateIMU(obj, Gyroscope, Accelerometer)</span></span>
<span class="srcline"><span class="lineno"><a href="7,67" id="srcline67">67</a></span><span class="line">            q = obj.Quaternion; <span class="comment">% short name local variable for readability</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,68" id="srcline68">68</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,69" id="srcline69">69</a></span><span class="line">            <span class="comment">% Normalise accelerometer measurement</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,70" id="srcline70">70</a></span><span class="line">            <span class="keyword">if</span>(norm(Accelerometer) == 0), <span class="keyword">return</span>; <span class="keyword">end</span>	<span class="comment">% handle NaN</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,71" id="srcline71">71</a></span><span class="line">            Accelerometer = Accelerometer / norm(Accelerometer);	<span class="comment">% normalise magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,72" id="srcline72">72</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,73" id="srcline73">73</a></span><span class="line">            <span class="comment">% Gradient decent algorithm corrective step</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,74" id="srcline74">74</a></span><span class="line">            F = [2*(q(2)*q(4) - q(1)*q(3)) - Accelerometer(1)</span></span>
<span class="srcline"><span class="lineno"><a href="7,75" id="srcline75">75</a></span><span class="line">                2*(q(1)*q(2) + q(3)*q(4)) - Accelerometer(2)</span></span>
<span class="srcline"><span class="lineno"><a href="7,76" id="srcline76">76</a></span><span class="line">                2*(0.5 - q(2)^2 - q(3)^2) - Accelerometer(3)];</span></span>
<span class="srcline"><span class="lineno"><a href="7,77" id="srcline77">77</a></span><span class="line">            J = [-2*q(3),	2*q(4),    -2*q(1),	2*q(2)</span></span>
<span class="srcline"><span class="lineno"><a href="7,78" id="srcline78">78</a></span><span class="line">                2*q(2),     2*q(1),     2*q(4),	2*q(3)</span></span>
<span class="srcline"><span class="lineno"><a href="7,79" id="srcline79">79</a></span><span class="line">                0,         -4*q(2),    -4*q(3),	0    ];</span></span>
<span class="srcline"><span class="lineno"><a href="7,80" id="srcline80">80</a></span><span class="line">            step = (J'*F);</span></span>
<span class="srcline"><span class="lineno"><a href="7,81" id="srcline81">81</a></span><span class="line">            step = step / norm(step);	<span class="comment">% normalise step magnitude</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,82" id="srcline82">82</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,83" id="srcline83">83</a></span><span class="line">            <span class="comment">% Compute rate of change of quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,84" id="srcline84">84</a></span><span class="line">            qDot = 0.5 * quaternProd(q, [0 Gyroscope(1) Gyroscope(2) Gyroscope(3)]) - obj.Beta * step';</span></span>
<span class="srcline"><span class="lineno"><a href="7,85" id="srcline85">85</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="7,86" id="srcline86">86</a></span><span class="line">            <span class="comment">% Integrate to yield quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,87" id="srcline87">87</a></span><span class="line">            q = q + qDot * obj.SamplePeriod;</span></span>
<span class="srcline"><span class="lineno"><a href="7,88" id="srcline88">88</a></span><span class="line">            obj.Quaternion = q / norm(q); <span class="comment">% normalise quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,89" id="srcline89">89</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,90" id="srcline90">90</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,91" id="srcline91">91</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="7,92" id="srcline92">92</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>
